
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>Bayesian-Crowd-Counting | Aircraft</title>
    <meta name="author" content="Aircraft" />
    <meta name="description" content="è°æ›¿æˆ‘ä¸Šå­¦ æˆ‘å¯ä»¥æ›¿ä½ ç¡è§‰" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 6.0.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>åŠ è½½è¿‡æ…¢è¯·å¼€å¯ç¼“å­˜ æµè§ˆå™¨é»˜è®¤å¼€å¯</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>AIRCRAFT</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;AIRCRAFT</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>Bayesian-Crowd-Counting</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/7/4
        </span>
        
        <span class="category">
            <a href="/categories/Paper/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Paper
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/Crowd-Counting/" style="color: #ffa2c4">
                    Crowd-Counting
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/Bayesian/" style="color: #ff7d73">
                    Bayesian
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h1 id="Bayesian-Crowd-Counting"><a href="#Bayesian-Crowd-Counting" class="headerlink" title="Bayesian-Crowd-Counting"></a>Bayesian-Crowd-Counting</h1><h2 id="1-è®ºæ–‡è§£è¯»"><a href="#1-è®ºæ–‡è§£è¯»" class="headerlink" title="1 è®ºæ–‡è§£è¯»"></a>1 è®ºæ–‡è§£è¯»</h2><p><a target="_blank" rel="noopener" href="https://openaccess.thecvf.com/content_ICCV_2019/papers/Ma_Bayesian_Loss_for_Crowd_Count_Estimation_With_Point_Supervision_ICCV_2019_paper.pdf">è®ºæ–‡ä¸‹è½½</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/127956794?ssr_src=heifetz&amp;utm_oi=1231655726918692864">ICCV19 (Oral)|åŸºäºè´å¶æ–¯æŸå¤±å‡½æ•°çš„äººç¾¤è®¡æ•° - çŸ¥ä¹</a></p>
<p><img src="https://raw.githubusercontent.com/Aircraft-carrier/PicGOO/main/images/gongshi1.png" /></p>
<p><img src="https://raw.githubusercontent.com/Aircraft-carrier/PicGOO/main/images/gongshi2.png"/></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/439435980">æ‹’ç» é«˜æ–¯çƒ­å›¾ ä½œä¸ºå‡gt | Bayesian Loss for Crowd Count Estimation with Point Supervision - çŸ¥ä¹ (zhihu.com)</a></p>
<p><strong>å…ˆéªŒ vs likelyhood vs åéªŒ</strong></p>
<ol>
<li>ï¼ˆå…ˆéªŒï¼‰ä¸€ä¸ªæ˜¯ å·²çŸ¥ç¬¬nä¸ªäººåœ¨å›¾ä¸Š, å…¶å‡ºç°åœ¨ç‚¹Xmçš„æ¦‚ç‡ï¼šä»¥labelä¸ºä¸­å¿ƒåšäºŒç»´é«˜æ–¯åˆ†å¸ƒï¼Œæ­¤å›¾ç§°ä¸ºå…ˆéªŒæ¦‚ç‡å›¾ï¼Œå³ç¬¬nä¸ªäººå‡ºç°åœ¨å„ä¸ªç‚¹å¤„çš„æ¦‚ç‡ã€‚</li>
<li>ï¼ˆlikehoodï¼‰ä¸€ä¸ªæ˜¯ å·²çŸ¥ç‚¹Xmæœ‰äºº, ä»–æ˜¯ç¬¬nä¸ªäººçš„æ¦‚ç‡ï¼šç¥ç»ç½‘ç»œçš„è¾“å‡ºå°±æ˜¯æ¦‚ç‡å¯†åº¦å›¾ï¼Œä¼°è®¡å‡ºå›¾ä¸­è¿™ä¸ªç‚¹æœ‰äººçš„æ¦‚ç‡å¤§å°ã€‚</li>
<li>ï¼ˆåéªŒï¼‰ä¸€ä¸ªæ˜¯ åœ¨ç‚¹Xmèƒ½çœ‹åˆ°ç¬¬nä¸ªäººçš„æ¦‚ç‡ã€‚prioræœä»å‡åŒ€åˆ†å¸ƒï¼ŒP(y_1), P(y_2) â€¦ P(y_N) å…¨ç›¸ç­‰.å³è·¯äºº1å·åˆ°nå·å‡ºç°åœ¨å›¾ä¸Šçš„æ¦‚ç‡ç›¸åŒ (æˆä»½ä¸€æ ·)</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/Aircraft-carrier/PicGOO/images/5ce4b79eecb56014b1ecd91d1cc9901.png"/></p>
<p><strong>ï¼ˆæ•´å¹…å›¾ä¸Šï¼‰è·¯äººnå‡ºç°çš„æ•°å­¦æœŸæœ›</strong>ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/Aircraft-carrier/PicGOO/images/a5369752b2b029941e29da24c2f2473.png"/></p>
<p><strong>Bayesian loss</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/Aircraft-carrier/PicGOO/images/a4949722d022e3b221a5e32055dc6fe.png"/></p>
<p><strong>èƒŒæ™¯è§†ä¸ºç±»åˆ«0ï¼Œâ€å¸æ”¶â€é›¶å¤´æ¦‚ç‡</strong></p>
<p>ç—›ç‚¹ï¼šæœ€ç»ˆè¾“å‡ºçš„heatmapä¸Šï¼ŒèƒŒæ™¯åŒºåŸŸçš„æ¦‚ç‡å€¼ä¸ä¸º0ã€‚ç½‘ç»œè¾“å‡ºçš„heatmapï¼ŒèƒŒæ™¯åŒºåŸŸå¯èƒ½æœ‰äº›é0ã€‚åéªŒæ¦‚ç‡mask(ç”¨é«˜æ–¯åˆ†å¸ƒè¡¨ç¤º)ï¼Œåœ¨å¾ˆè¿œå¤„å¿…ç„¶è¿˜å¤§äº0ã€‚</p>
<blockquote>
<p>åˆ©ç”¨èƒŒæ™¯å“‘å…ƒï¼Œæˆ‘ä»¬å¯ä»¥â€œå¸æ”¶â€è¿œç¦»äººç¾¤çš„èƒŒæ™¯åŒºåŸŸåƒç´ çš„â€œè´¡çŒ®â€</p>
</blockquote>
<p>èƒŒæ™¯å“‘å…ƒï¼šæŠŠèƒŒæ™¯çš„æŸå¤„ï¼Œå½“ä½œä¸­å¿ƒ</p>
<p><strong>å¢å¼ºçš„è´å¶æ–¯æŸå¤±å‡½æ•° Bayesian Loss+</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/Aircraft-carrier/PicGOO/images/918903c119ac929b5c2027246e1f3ea.png"/></p>
<p><strong>å›¾ä¸Šæ€»äººæ•°C</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/Aircraft-carrier/PicGOO/images/ba1edb7aac63851a5191c70d9a807b3.png"/></p>
<h2 id="2-æ•°æ®é›†"><a href="#2-æ•°æ®é›†" class="headerlink" title="2 æ•°æ®é›†"></a>2 æ•°æ®é›†</h2><p><a target="_blank" rel="noopener" href="https://www.crcv.ucf.edu/data/ucf-qnrf/UCF-QNRF_ECCV18.zip">æ•°æ®é›†</a></p>
<h3 id="2-1-ğŸŒ»æ•°æ®é›†ä¸‹è½½"><a href="#2-1-ğŸŒ»æ•°æ®é›†ä¸‹è½½" class="headerlink" title="2.1 ğŸŒ»æ•°æ®é›†ä¸‹è½½"></a>2.1 ğŸŒ»æ•°æ®é›†ä¸‹è½½</h3><p>æœåŠ¡å™¨ç«¯å¼€å¯å¤šçº¿ç¨‹åŠ é€Ÿä¸‹è½½</p>
<pre><code class="lang-bash">aria2c --check-certificate=false -x 10 -k 1M -o /tmp/UCF-QNRF_ECCV18.zip https://www.crcv.ucf.edu/data/ucf-qnrf/UCF-QNRF_ECCV18.zip
</code></pre>
<h3 id="2-2-ğŸŒµæ•°æ®é›†ä»‹ç»"><a href="#2-2-ğŸŒµæ•°æ®é›†ä»‹ç»" class="headerlink" title="2.2 ğŸŒµæ•°æ®é›†ä»‹ç»"></a>2.2 ğŸŒµæ•°æ®é›†ä»‹ç»</h3><p>ä»ç¤¾ä¼šæ”¿æ²»å’Œå®‰å…¨çš„è§’åº¦æ¥çœ‹ï¼Œåœ¨å¯†é›†çš„äººç¾¤åœºæ™¯ä¸­è‡ªåŠ¨è®¡æ•°å’Œå®šä½å…·æœ‰é‡è¦æ„ä¹‰ã€‚äººç¾¤èšé›†åœ¨ä¸–ç•Œå„åœ°ï¼Œåœ¨å„ç§æƒ…å†µä¸‹ï¼Œè®¡ç®—å‚ä¸è€…äººæ•°é€šå¸¸æ˜¯ç»„ç»‡è€…å’Œæ‰§æ³•æœºæ„å…³æ³¨çš„é‡è¦é—®é¢˜ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Aircraft-carrier/PicGOO/main/images/crowd.png" /></p>
<p>UCF-QNRFæ•°æ®é›†æ˜¯ä¸€ä¸ªï¼Œç”±å¼—ç½—é‡Œè¾¾å¤§å­¦åœ¨2018å¹´å‘å¸ƒã€‚è¯¥æ•°æ®é›†åœ¨æ ¼å¼å’Œå†…å®¹ä¸Šå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li><strong>å›¾åƒæ•°é‡</strong>ï¼šUCF-QNRFæ•°æ®é›†å…±åŒ…å«1535å¼ é«˜æ¸…å¤§å›¾ï¼Œè¿™äº›å›¾åƒå‡ä¸ºçœŸå®åœºæ™¯ä¸‹çš„æˆ·å¤–å›¾åƒï¼Œå…·æœ‰æé«˜çš„åˆ†è¾¨ç‡ï¼ˆå¦‚2013*2902ï¼‰ï¼Œé€‚ç”¨äºè®­ç»ƒéœ€è¦é«˜åˆ†è¾¨ç‡è¾“å…¥çš„æ¨¡å‹ã€‚</li>
<li><strong>å›¾åƒåˆ†ç±»</strong>ï¼šæ•°æ®é›†è¢«åˆ†ä¸ºè®­ç»ƒé›†å’Œæµ‹è¯•é›†ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­è®­ç»ƒé›†åŒ…å«1201å¼ å›¾åƒï¼Œæµ‹è¯•é›†åŒ…å«334å¼ å›¾åƒã€‚è¿™ç§åˆ’åˆ†æ–¹å¼æœ‰åŠ©äºåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è¯„ä¼°æ¨¡å‹çš„æ€§èƒ½ï¼Œå¹¶åœ¨æœ€ç»ˆæµ‹è¯•é˜¶æ®µéªŒè¯æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</li>
<li><strong>æ ‡æ³¨ä¿¡æ¯</strong>ï¼šæ¯å¼ å›¾åƒéƒ½é™„æœ‰è¯¦ç»†çš„æ ‡æ³¨ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯é€šå¸¸ä»¥MATæ–‡ä»¶çš„å½¢å¼å­˜å‚¨ã€‚æ ‡æ³¨å†…å®¹åŒ…æ‹¬äº†å›¾åƒä¸­æ¯ä¸ªäººçš„å¤´éƒ¨ä½ç½®åæ ‡ï¼ˆå¦‚[y0, x0]ï¼‰ï¼Œç”¨äºè®¡ç®—å›¾åƒä¸­çš„äººç¾¤å¯†åº¦å’Œç”Ÿæˆäººç¾¤å¯†åº¦å›¾ã€‚æ­¤å¤–ï¼Œæ ‡æ³¨è¿˜å¯èƒ½åŒ…æ‹¬å…¶ä»–ä¿¡æ¯ï¼Œå¦‚äººç¾¤å¯†åº¦ç­‰çº§ã€åœºæ™¯ç±»åˆ«ç­‰ã€‚</li>
<li><strong>åœºæ™¯å¤šæ ·æ€§</strong>ï¼šUCF-QNRFæ•°æ®é›†åŒ…å«äº†å¤šç§åœºæ™¯ã€å¤šä¸ªè§†è§’ã€å¤šç§å…‰çº¿åŠå¯†åº¦å˜åŒ–çš„å¤§è§„æ¨¡å·²æ ‡æ³¨äººä½“ã€‚è¿™äº›å›¾åƒæ¶µç›–äº†å»ºç­‘ã€æ¤è¢«ã€å¤©ç©ºå’Œé“è·¯ç­‰ä¸–ç•Œå„åœ°çš„æˆ·å¤–çœŸå®åœºæ™¯ï¼Œå¯¹äºç ”ç©¶ä¸åŒåœ°åŒºäººç¾¤å¯†åº¦å…·æœ‰é‡è¦æ„ä¹‰ã€‚åŒæ—¶ï¼Œæ•°æ®é›†ä¸­çš„å›¾åƒåœ¨äººç¾¤å¯†åº¦ã€å…‰ç…§æ¡ä»¶ã€æ‹æ‘„è§’åº¦ç­‰æ–¹é¢å…·æœ‰è¾ƒå¤§çš„å˜åŒ–èŒƒå›´ï¼Œæœ‰åŠ©äºè®­ç»ƒå‡ºæ›´åŠ é²æ£’å’Œæ³›åŒ–èƒ½åŠ›æ›´å¼ºçš„æ¨¡å‹ã€‚</li>
</ul>
<p>ç»¼ä¸Šæ‰€è¿°ï¼ŒUCF-QNRFæ•°æ®é›†åœ¨æ ¼å¼å’Œå†…å®¹ä¸Šéƒ½å…·æœ‰è¾ƒé«˜çš„è§„èŒƒæ€§å’Œä¸°å¯Œæ€§ã€‚å®ƒæä¾›äº†å¤§é‡é«˜æ¸…å¤§å›¾ä»¥åŠè¯¦ç»†çš„æ ‡æ³¨ä¿¡æ¯ï¼Œä¸ºè®­ç»ƒå’Œè¯„ä¼°å¤§è§„æ¨¡äººç¾¤å¯†é›†è®¡æ•°æ¨¡å‹æä¾›äº†æœ‰åŠ›çš„æ”¯æŒã€‚åŒæ—¶ï¼Œæ•°æ®é›†çš„å¤šæ ·æ€§å’Œå¤æ‚æ€§ä¹Ÿä¸ºæ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›å’Œé²æ£’æ€§æå‡ºäº†æ›´é«˜çš„è¦æ±‚ã€‚</p>
<h3 id="2-3-â˜˜ï¸äººå£å¯†åº¦å›¾ç”Ÿæˆ"><a href="#2-3-â˜˜ï¸äººå£å¯†åº¦å›¾ç”Ÿæˆ" class="headerlink" title="2.3 â˜˜ï¸äººå£å¯†åº¦å›¾ç”Ÿæˆ"></a>2.3 â˜˜ï¸äººå£å¯†åº¦å›¾ç”Ÿæˆ</h3><p><strong>äººå£å¯†åº¦å›¾ç”Ÿæˆè¿‡ç¨‹æ€»å…±ä¸¤éƒ¨åˆ†</strong></p>
<ol>
<li>åˆ©ç”¨åæ ‡æ•°æ®<code>mat</code>æ–‡ä»¶ç”Ÿæˆç‚¹æ³¨é‡Š<code>ground_truth</code>å›¾</li>
<li>åˆ©ç”¨<code>gaussian_filter</code>å‡½æ•°ç”Ÿæˆäººå£å¯†åº¦å›¾</li>
</ol>
<p>è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨UCF-QNRFçš„å›¾ç‰‡ä½œä¸ºè®­ç»ƒé›†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="https://raw.githubusercontent.com/Aircraft-carrier/PicGOO/main/images/crowd1.png"/></p>
<p><code>ground_truth</code>æ•°æ®é›†æ˜¯ç”±<code>mat</code>æ–‡ä»¶ç»„æˆçš„ï¼Œæ•°æ®æ ¼å¼ä¸º<code>[y0,x0]</code><strong>(ä¸åŒæ•°æ®é›†è¡¨ç¤ºçš„æ–¹æ³•ä¸åŒ)</strong>è¡¨ç¤ºäººå¤´æ‰€åœ¨çš„åƒç´ ç‚¹ã€‚åˆ©ç”¨<code>scipy</code>å‡½æ•°å³å¯è¯»å–æ•°æ®ã€‚</p>
<p><strong>åŠ è½½æ•°æ®ï¼ŒåŠ è½½å›¾ç‰‡å’Œmatæ–‡ä»¶</strong></p>
<pre><code class="lang-python">gt = scipy.io.loadmat(&quot;./UCF-QNRF/Test/img_0001_ann.mat&quot;)
img = cv2.imread(&quot;./UCF-QNRF/Test/img_0001.jpg&quot;)
</code></pre>
<p><strong>åˆ©ç”¨matæ–‡ä»¶ç”Ÿæˆç‚¹æ³¨é‡Š-ground_truthå›¾</strong></p>
<pre><code class="lang-python">k = np.zeros((img.shape[0],img.shape[1]))
for i in range(len(gt)):#ç”Ÿæˆå¤´éƒ¨ç‚¹æ³¨é‡Šå›¾
    if gt[i][0] &lt; img.shape[1] and gt[i][1] &lt; img.shape[0]:
        k[int(gt[i][1])][int(gt[i][0])] += gt[i][2]
</code></pre>
<p><strong>åˆ©ç”¨ground_truthå›¾ç»è¿‡é«˜æ–¯æ»¤æ³¢</strong></p>
<pre><code class="lang-python">def gaussian_filter_density(gt):
    # åˆå§‹åŒ–å¯†åº¦å›¾
    density = np.zeros(gt.shape, dtype=np.float32)
    # è·å–gtä¸­ä¸ä¸º0çš„å…ƒç´ çš„ä¸ªæ•°
    gt_count = np.count_nonzero(gt)
    # å¦‚æœgtå…¨ä¸º0ï¼Œå°±è¿”å›å…¨0çš„å¯†åº¦å›¾
    if gt_count == 0:
        return density
    sigma = 16
    density += scipy.ndimage.filters.gaussian_filter(gt, sigma, mode=&#39;constant&#39;)
    return density
</code></pre>
<p><strong>å®Œæ•´ä»£ç </strong></p>
<pre><code class="lang-python">import numpy as np
from matplotlib import pyplot as plt
from matplotlib import cm as CM
import cv2
import scipy.ndimage
import scipy.io
def gaussian_filter_density(gt):
    # åˆå§‹åŒ–å¯†åº¦å›¾
    density = np.zeros(gt.shape, dtype=np.float32)
    # è·å–gtä¸­ä¸ä¸º0çš„å…ƒç´ çš„ä¸ªæ•°
    gt_count = np.count_nonzero(gt)
    # å¦‚æœgtå…¨ä¸º0ï¼Œå°±è¿”å›å…¨0çš„å¯†åº¦å›¾
    if gt_count == 0:
        return density 
    sigma = 16
    density += scipy.ndimage.filters.gaussian_filter(gt, sigma, mode=&#39;constant&#39;)
    return density
def density_map(img,gt):
    k = np.zeros((img.shape[0],img.shape[1]))
    for i in range(len(gt)):#ç”Ÿæˆå¤´éƒ¨ç‚¹æ³¨é‡Šå›¾
        if gt[i][0] &lt; img.shape[1] and gt[i][1] &lt; img.shape[0]:
            k[int(gt[i][1])][int(gt[i][0])] += gt[i][2]
    k = gaussian_filter_density(k)
    return k
# gt = scipy.io.loadmat(&quot;./UCF-QNRF_ECCV18/Test/img_0001_ann.mat&quot;)
gt = np.load(&quot;teddy\\UCF-Train-Val-Test\\train\\img_0001.npy&quot;)
img = cv2.imread(&quot;teddy\\UCF-Train-Val-Test\\train\\img_0001.jpg&quot;)

groundtruth = density_map(img,gt)
plt.figure(2)

plt.imshow(groundtruth,cmap=CM.jet)
plt.show()
</code></pre>
<p><strong>ç»“æœ</strong></p>
<p><img src="https://raw.githubusercontent.com/Aircraft-carrier/PicGOO/main/images/crowd2.png"/></p>
<h2 id="3-ä»£ç åˆ†æ"><a href="#3-ä»£ç åˆ†æ" class="headerlink" title="3 ä»£ç åˆ†æ"></a>3 ä»£ç åˆ†æ</h2><p><a target="_blank" rel="noopener" href="https://github.com/ZhihengCV/Bayesian-Crowd-Counting.git">ä»“åº“åœ°å€</a></p>
<h3 id="3-1-ğŸ»datasetå’Œdataloadâ€”â€”â€”è¿­ä»£å™¨è®¾è®¡"><a href="#3-1-ğŸ»datasetå’Œdataloadâ€”â€”â€”è¿­ä»£å™¨è®¾è®¡" class="headerlink" title="3.1 ğŸ»datasetå’Œdataloadâ€”â€”â€”è¿­ä»£å™¨è®¾è®¡"></a>3.1 ğŸ»datasetå’Œdataloadâ€”â€”â€”è¿­ä»£å™¨è®¾è®¡</h3><p>åœ¨PyTorchä¸­ï¼Œ<code>Dataset</code>æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œç”¨äºè¡¨ç¤ºæ•°æ®é›†çš„æŠ½è±¡ã€‚<code>Dataset</code>å¯¹è±¡è´Ÿè´£æä¾›æ•°æ®çš„ç´¢å¼•ã€æ•°æ®çš„è·å–ä»¥åŠæ•°æ®çš„è½¬æ¢ï¼ˆå¯é€‰ï¼‰ã€‚é€šè¿‡<code>Dataset</code>ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•°æ®åŠ è½½åˆ°PyTorchä¸­ï¼Œä»¥ä¾¿è¿›è¡Œæ¨¡å‹çš„è®­ç»ƒå’Œè¯„ä¼°ã€‚</p>
<h4 id="3-1-1-è‡ªå®šä¹‰Datasetå’Œdataloadçš„åˆ†æ"><a href="#3-1-1-è‡ªå®šä¹‰Datasetå’Œdataloadçš„åˆ†æ" class="headerlink" title="3.1.1 è‡ªå®šä¹‰Datasetå’Œdataloadçš„åˆ†æ"></a>3.1.1 è‡ªå®šä¹‰Datasetå’Œdataloadçš„åˆ†æ</h4><p>åœ¨PyTorchä¸­ï¼Œé€šå¸¸é€šè¿‡ç»§æ‰¿<code>torch.utils.data.Dataset</code>ç±»æ¥åˆ›å»ºè‡ªå®šä¹‰çš„<code>Dataset</code>ã€‚åœ¨ç»§æ‰¿çš„ç±»ä¸­ï¼Œä½ éœ€è¦å®ç°ä¸¤ä¸ªä¸»è¦çš„æ–¹æ³•ï¼š</p>
<ul>
<li><code>__len__()</code>ï¼šè¿”å›æ•°æ®é›†ä¸­çš„æ ·æœ¬æ•°ã€‚</li>
<li><code>__getitem__(index)</code>ï¼šæ ¹æ®ç»™å®šçš„ç´¢å¼•è¿”å›æ•°æ®é›†ä¸­çš„å•ä¸ªæ ·æœ¬ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šè‡ªå®šä¹‰Dataset</strong></p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„æ•°æ®é›†ï¼Œå…¶ä¸­åŒ…å«ä¸€äº›å›¾åƒè·¯å¾„å’Œå¯¹åº”çš„æ ‡ç­¾ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„<code>Dataset</code>ï¼š</p>
<pre><code class="lang-python">import torch  
from torch.utils.data import Dataset, DataLoader  
from PIL import Image  
import os  

class CustomDataset(Dataset):  
    def __init__(self, data_dir, transform=None):  
        &quot;&quot;&quot;  
        åˆå§‹åŒ–Dataset  
        :param data_dir: æ•°æ®é›†æ‰€åœ¨çš„ç›®å½•  
        :param transform: å¯é€‰çš„æ•°æ®è½¬æ¢æ“ä½œ  
        &quot;&quot;&quot;  
        self.data_dir = data_dir  
        self.transform = transform  
        self.image_paths = [os.path.join(data_dir, img) for img in os.listdir(data_dir) if img.endswith((&#39;.png&#39;, &#39;.jpg&#39;, &#39;.jpeg&#39;))]  
        self.labels = [1 if &#39;cat&#39; in img else 0 for img in self.image_paths]  # å‡è®¾æ–‡ä»¶ååŒ…å«&#39;cat&#39;çš„æ˜¯çŒ«ï¼Œå¦åˆ™æ˜¯å…¶ä»–  

    def __len__(self):  
        return len(self.image_paths)  

    def __getitem__(self, idx):  
        img_path = self.image_paths[idx]  
        image = Image.open(img_path).convert(&#39;RGB&#39;)  
        label = self.labels[idx]  

        if self.transform:  
            image = self.transform(image)  

        return image, label  

# ä½¿ç”¨ç¤ºä¾‹  
transform = torchvision.transforms.Compose([  
    torchvision.transforms.Resize((224, 224)),  
    torchvision.transforms.ToTensor(),  
])  

dataset = CustomDataset(data_dir=&#39;path_to_your_dataset&#39;, transform=transform)  
dataloader = DataLoader(dataset, batch_size=4, shuffle=True)  

# ç°åœ¨å¯ä»¥ä½¿ç”¨dataloaderæ¥è¿­ä»£æ•°æ®é›†äº†  
for images, labels in dataloader:  
    # è¿›è¡Œè®­ç»ƒæˆ–è¯„ä¼°  
    pass
</code></pre>
<h4 id="3-1-2-ä½¿ç”¨è‡ªå®šä¹‰Dataset"><a href="#3-1-2-ä½¿ç”¨è‡ªå®šä¹‰Dataset" class="headerlink" title="3.1.2 ä½¿ç”¨è‡ªå®šä¹‰Dataset"></a>3.1.2 ä½¿ç”¨è‡ªå®šä¹‰Dataset</h4><p>åœ¨åˆ›å»ºäº†è‡ªå®šä¹‰çš„<code>Dataset</code>åï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨<code>DataLoader</code>æ¥å°è£…å®ƒã€‚<code>DataLoader</code>æä¾›äº†æ‰¹é‡åŠ è½½æ•°æ®ã€æ‰“ä¹±æ•°æ®ã€å¤šè¿›ç¨‹åŠ è½½ç­‰åŠŸèƒ½ï¼Œéå¸¸é€‚åˆç”¨äºè®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹ã€‚</p>
<p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>DataLoader</code>æ¥åŠ è½½å’Œè¿­ä»£æ•°æ®ã€‚<code>DataLoader</code>çš„å‚æ•°åŒ…æ‹¬<code>dataset</code>ï¼ˆæ•°æ®é›†å¯¹è±¡ï¼‰ã€<code>batch_size</code>ï¼ˆæ¯ä¸ªbatchçš„æ ·æœ¬æ•°ï¼‰ã€<code>shuffle</code>ï¼ˆæ˜¯å¦åœ¨æ¯ä¸ªepochå¼€å§‹æ—¶æ‰“ä¹±æ•°æ®ï¼‰ç­‰ã€‚</p>
<p>é€šè¿‡è‡ªå®šä¹‰<code>Dataset</code>å’Œä½¿ç”¨<code>DataLoader</code>ï¼Œä½ å¯ä»¥æ–¹ä¾¿åœ°å°†ä»»ä½•å½¢å¼çš„æ•°æ®é›†åŠ è½½åˆ°PyTorchä¸­ï¼Œä¸ºæ·±åº¦å­¦ä¹ æ¨¡å‹çš„è®­ç»ƒå’Œè¯„ä¼°æä¾›æ‰€éœ€çš„æ•°æ®ã€‚è¿™æ˜¯PyTorchå¤„ç†æ•°æ®é›†çš„æ ¸å¿ƒæ–¹æ³•ï¼ŒæŒæ¡è¿™ä¸€ç‚¹å¯¹äºæ·±å…¥ä½¿ç”¨PyTorchè¿›è¡Œæ·±åº¦å­¦ä¹ è‡³å…³é‡è¦ã€‚</p>
<h4 id="3-1-3-é¡¹ç›®datasetåˆ†æ"><a href="#3-1-3-é¡¹ç›®datasetåˆ†æ" class="headerlink" title="3.1.3 é¡¹ç›®datasetåˆ†æ"></a>3.1.3 é¡¹ç›®datasetåˆ†æ</h4><p><strong>ä¸¤ä¸ªåŠŸèƒ½å‡½æ•°ï¼ŒåŠŸèƒ½å§”æ´¾</strong></p>
<pre><code class="lang-python">def random_crop(im_h, im_w, crop_h, crop_w):
    res_h = im_h - crop_h
    res_w = im_w - crop_w
    i = random.randint(0, res_h)
    j = random.randint(0, res_w)
    return i, j, crop_h, crop_w


def cal_innner_area(c_left, c_up, c_right, c_down, bbox):    # è£å‰ªåŒºåŸŸçš„å·¦ã€ä¸Šã€å³ã€ä¸‹è¾¹ç•Œã€‚
    inner_left = np.maximum(c_left, bbox[:, 0])
    inner_up = np.maximum(c_up, bbox[:, 1])
    inner_right = np.minimum(c_right, bbox[:, 2])
    inner_down = np.minimum(c_down, bbox[:, 3])
    inner_area = np.maximum(inner_right-inner_left, 0.0) * np.maximum(inner_down-inner_up, 0.0)
    return inner_area                                        # è£å‰ªåŒºåŸŸä¸æ¯ä¸ªè¾¹ç•Œæ¡†ä¹‹é—´å†…åˆ‡åŒºåŸŸçš„é¢ç§¯æ•°ç»„ã€‚
</code></pre>
<p>è¿™ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«å®ç°äº†<strong>éšæœºè£å‰ª</strong>å’Œ<strong>è®¡ç®—è£å‰ªåŒºåŸŸä¸è¾¹ç•Œæ¡†ä¹‹é—´å†…åˆ‡åŒºåŸŸé¢ç§¯</strong>çš„åŠŸèƒ½ã€‚ä¸‹é¢æ˜¯å¯¹è¿™ä¸¤ä¸ªå‡½æ•°çš„è¯¦ç»†åˆ†æï¼š</p>
<ul>
<li><p><code>random_crop</code> å‡½æ•°ï¼š<strong>åŠŸèƒ½</strong>ï¼šç”Ÿæˆä¸€ä¸ªéšæœºè£å‰ªåŒºåŸŸçš„å·¦ä¸Šè§’åæ ‡ï¼ˆ<code>i, j</code>ï¼‰ä»¥åŠè£å‰ªåŒºåŸŸçš„é«˜åº¦ï¼ˆ<code>crop_h</code>ï¼‰å’Œå®½åº¦ï¼ˆ<code>crop_w</code>ï¼‰ã€‚</p>
</li>
<li><p><code>cal_innner_area</code> å‡½æ•°ï¼š<strong>åŠŸèƒ½</strong>ï¼šè®¡ç®—ä¸€ä¸ªè£å‰ªåŒºåŸŸï¼ˆç”±<code>c_left, c_up, c_right, c_down</code>å®šä¹‰ï¼‰ä¸å¤šä¸ªè¾¹ç•Œæ¡†ï¼ˆ<code>bbox</code>ï¼‰ä¹‹é—´çš„å†…åˆ‡åŒºåŸŸé¢ç§¯ã€‚</p>
</li>
</ul>
<p><strong>å…·ä½“ç±»å®ç°</strong></p>
<pre><code class="lang-python">class Crowd(data.Dataset):
    def __init__(self, root_path, crop_size,
                 downsample_ratio, is_gray=False,
                 method=&#39;train&#39;):

        self.root_path = root_path
        self.im_list = sorted(glob(os.path.join(self.root_path, &#39;*.jpg&#39;)))

        if method not in [&#39;train&#39;, &#39;val&#39;]:
            raise Exception(&quot;not implement&quot;)
        self.method = method

        self.c_size = crop_size
        self.d_ratio = downsample_ratio
        assert self.c_size % self.d_ratio == 0
        self.dc_size = self.c_size // self.d_ratio

        if is_gray:
            self.trans = transforms.Compose([
                transforms.ToTensor(),
                transforms.Normalize([0.5, 0.5, 0.5], [0.5, 0.5, 0.5])
            ])
        else:
            self.trans = transforms.Compose([
                transforms.ToTensor(),
                transforms.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])
            ])

    def __len__(self):
        return len(self.im_list)


    def __getitem__(self, item):
        img_path = self.im_list[item]
        gd_path = img_path.replace(&#39;jpg&#39;, &#39;npy&#39;)
        img = Image.open(img_path).convert(&#39;RGB&#39;)

        if self.method == &#39;train&#39;:
            keypoints = np.load(gd_path)                    
            return self.train_transform(img, keypoints)     
        elif self.method == &#39;val&#39;:
            keypoints = np.load(gd_path)
            img = self.trans(img)
            name = os.path.basename(img_path).split(&#39;.&#39;)[0]  
            return img, len(keypoints), name                    

    def train_transform(self, img, keypoints):
    -------
        return self.trans(img), torch.from_numpy(keypoints.copy()).float(), \
               torch.from_numpy(target.copy()).float(), st_size
</code></pre>
<p><code>Crowd</code>å®ç°äº†ä¸¤ç§æ¨¡å¼å¯é€‰çš„<code>dataset</code>ä½¿å¾—<code>train</code>å’Œ<code>val</code>å¯ä»¥ä½¿ç”¨ä¸åŒçš„<code>dataset</code>ã€‚<strong>but why ? </strong></p>
<pre><code class="lang-python">self.dataloaders = &#123;x: DataLoader(self.datasets[x],
                                  collate_fn=(train_collate
                                              if x == &#39;train&#39; else default_collate),
                                  batch_size=(args.batch_size
                                              if x == &#39;train&#39; else 1),
                                  shuffle=(True if x == &#39;train&#39; else False),
                                  num_workers=args.num_workers*self.device_count,
                                  pin_memory=(True if x == &#39;train&#39; else False))
                    for x in [&#39;train&#39;, &#39;val&#39;]&#125;
</code></pre>
<p><code>datasets[train]</code>æ¯æ¬¡è¿­ä»£è¿”å›ï¼šè£å‰ªåå›¾ç‰‡ï¼Œä¿ç•™çš„å…³é”®ç‚¹ï¼Œç­›é€‰åçš„å…³é”®ç‚¹å¯¹åº”çš„äº¤å‰é¢ç§¯æ¯”ä¾‹ï¼Œä»¥åŠåŸå§‹å›¾åƒçš„è¾ƒçŸ­è¾¹å°ºå¯¸ã€‚</p>
<p><code>datasets[val]</code>æ¯æ¬¡è¿­ä»£è¿”å›ï¼šåŸå§‹å›¾ç‰‡ï¼Œå›¾ç‰‡å…³é”®ç‚¹æ•°é‡å’Œå›¾ç‰‡åå­—ã€‚</p>
<p>å…³é”®ç‚¹å¯èƒ½ç”±å¤šä¸ªç»´åº¦è¡¨ç¤ºï¼Œæ¯”å¦‚xåæ ‡ã€yåæ ‡å’ŒæŸç§å½¢å¼çš„ç½®ä¿¡åº¦æˆ–å¯è§æ€§æ ‡å¿—(å¤´çš„å¤§å°èŒƒå›´)ã€‚</p>
<ol>
<li><strong>æ•°æ®åˆ’åˆ†çš„ç›®çš„</strong>ï¼š<br>è®­ç»ƒé›†çš„ä¸»è¦ç›®çš„æ˜¯è®©æ¨¡å‹å­¦ä¹ æ•°æ®ä¸­çš„æ¨¡å¼å’Œç‰¹å¾ã€‚éªŒè¯é›†åˆ™ç”¨äºåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ç›‘æ§æ¨¡å‹çš„æ€§èƒ½ï¼Œä»¥ä¾¿è¿›è¡Œè¶…å‚æ•°è°ƒæ•´ã€æ—©åœï¼ˆearly stoppingï¼‰ç­‰ç­–ç•¥æ¥é˜²æ­¢è¿‡æ‹Ÿåˆã€‚ç”±äºè¿™ä¸¤ä¸ªé›†åˆçš„ç›®çš„ä¸åŒï¼Œå› æ­¤å®ƒä»¬è¿”å›çš„å†…å®¹ä¹Ÿå¯èƒ½ä¸åŒï¼Œä»¥æ»¡è¶³å„è‡ªçš„éœ€æ±‚ã€‚</li>
<li><strong>è¯„ä¼°æŒ‡æ ‡å’Œå…³æ³¨ç‚¹</strong>ï¼š<br>åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½æ›´å…³æ³¨æ¨¡å‹åœ¨è®­ç»ƒé›†ä¸Šçš„æŸå¤±ï¼ˆlossï¼‰ä¸‹é™æƒ…å†µï¼Œè€Œåœ¨éªŒè¯é›†ä¸Šåˆ™æ›´å…³æ³¨å„ç§è¯„ä¼°æŒ‡æ ‡ï¼ˆå¦‚å‡†ç¡®ç‡ã€å¬å›ç‡ã€F1åˆ†æ•°ç­‰ï¼‰çš„è¡¨ç°ã€‚ç”±äºè¿™äº›å…³æ³¨ç‚¹ä¸åŒï¼Œå› æ­¤è®­ç»ƒé›†å’ŒéªŒè¯é›†è¿”å›çš„å†…å®¹å¯èƒ½ä¹Ÿä¸åŒï¼Œä»¥ä¾¿åˆ†åˆ«è®¡ç®—è¿™äº›æŒ‡æ ‡ã€‚</li>
<li><strong>æ•°æ®æ ¼å¼å’Œé¢„å¤„ç†çš„æ ‡å‡†åŒ–</strong>ï¼š<br>è™½ç„¶è®­ç»ƒé›†å’ŒéªŒè¯é›†çš„æ•°æ®æ ¼å¼åº”è¯¥ä¿æŒä¸€è‡´ï¼ˆä¾‹å¦‚ï¼Œéƒ½æ˜¯å›¾åƒæ–‡ä»¶æˆ–æ–‡æœ¬æ–‡ä»¶ï¼‰ï¼Œä½†åœ¨é¢„å¤„ç†é˜¶æ®µï¼Œå®ƒä»¬å¯èƒ½ä¼šç»å†ä¸åŒçš„æ­¥éª¤æˆ–å‚æ•°è®¾ç½®ã€‚è¿™äº›é¢„å¤„ç†æ­¥éª¤å¯èƒ½åŒ…æ‹¬æ•°æ®å½’ä¸€åŒ–ã€æ ‡å‡†åŒ–ã€ç¼–ç ç­‰ï¼Œä»¥ç¡®ä¿æ¨¡å‹èƒ½å¤Ÿæ­£ç¡®å¤„ç†è¾“å…¥æ•°æ®ã€‚ç”±äºè®­ç»ƒé›†å’ŒéªŒè¯é›†å¯èƒ½ä½¿ç”¨ä¸åŒçš„é¢„å¤„ç†å‚æ•°æˆ–æ­¥éª¤ï¼Œå› æ­¤å®ƒä»¬è¿”å›çš„å†…å®¹ä¹Ÿå¯èƒ½ä¸åŒã€‚</li>
</ol>
<pre><code class="lang-python">def train_transform(self, img, keypoints):
    &quot;&quot;&quot;random crop image patch and find people in it&quot;&quot;&quot;
    wd, ht = img.size
    st_size = min(wd, ht)
    assert st_size &gt;= self.c_size
    assert len(keypoints) &gt; 0
    i, j, h, w = random_crop(ht, wd, self.c_size, self.c_size)     
    img = F.crop(img, i, j, h, w)                                         # å¯¹å›¾ç‰‡è¿›è¡Œéšæœºåˆ‡ç‰‡
    nearest_dis = np.clip(keypoints[:, 2], 4.0, 128.0)  

    points_left_up = keypoints[:, :2] - nearest_dis[:, None] / 2.0

    points_right_down = keypoints[:, :2] + nearest_dis[:, None] / 2.0
    bbox = np.concatenate((points_left_up, points_right_down), axis=1)   # æ‰€æœ‰å…³é”®åŒºåŸŸçš„è¾¹ç•Œæ¡†

    inner_area = cal_innner_area(j, i, j+w, i+h, bbox)                   # è®¡ç®—éšæœºé€‰ä¸­çš„è¾¹ç•Œæ¡†ä¸æ‰€æœ‰å…³é”®åŒºåŸŸçš„äº¤å‰éƒ¨åˆ†é¢ç§¯
    origin_area = nearest_dis * nearest_dis                              # æ‰€æœ‰å…³é”®åŒºåŸŸçš„é¢ç§¯
    ratio = np.clip(1.0 * inner_area / origin_area, 0.0, 1.0)            
    mask = (ratio &gt;= 0.3)

    target = ratio[mask]
    keypoints = keypoints[mask]
    keypoints = keypoints[:, :2] - [j, i]  
    if len(keypoints) &gt; 0:
        if random.random() &gt; 0.5:
            img = F.hflip(img)
            keypoints[:, 0] = w - keypoints[:, 0]
    else:
        if random.random() &gt; 0.5:
            img = F.hflip(img)
    return self.trans(img), torch.from_numpy(keypoints.copy()).float(), torch.from_numpy(target.copy()).float(), st_size
</code></pre>
<blockquote>
<p>å…³é”®åŒºåŸŸå¯ä»¥çœ‹ä½œæ˜¯è¿™ä¸ªç©ºé—´è¢«ç›®æ ‡èº«ä½“éƒ¨åˆ†å æ®ã€‚</p>
</blockquote>
<ul>
<li><code>nearest_dis = np.clip(keypoints[:, 2], 4.0, 128.0)</code></li>
</ul>
<p>ä»keypointsæ•°ç»„ä¸­å–å‡ºæ‰€æœ‰å…³é”®ç‚¹çš„ç¬¬ä¸‰ä¸ªç»´åº¦çš„å€¼ï¼Œç„¶åå°†è¿™äº›å€¼é™åˆ¶åœ¨4.0åˆ°128.0çš„èŒƒå›´å†…ã€‚å¦‚æœæŸä¸ªå…³é”®ç‚¹çš„è¿™ä¸ªå€¼å°äº4.0ï¼Œåˆ™å°†å…¶æ›¿æ¢ä¸º4.0ï¼›å¦‚æœå¤§äº128.0ï¼Œåˆ™æ›¿æ¢ä¸º128.0ï¼›</p>
<ul>
<li><code>points_left_up = keypoints[:, :2] - nearest_dis[:, None] / 2.0</code></li>
</ul>
<p><code>keypoints[:, :2]</code>æ˜¯<code>(N, 2)</code>å½¢çŠ¶ï¼Œè€Œ<code>nearest_dis[:, None] / 2.0</code>æ˜¯<code>(N, 1)</code>å½¢çŠ¶ï¼Œå¹¶ä¸”NumPyçš„å¹¿æ’­è§„åˆ™å…è®¸è¿™ç§å½¢çŠ¶çš„æ•°ç»„è¿›è¡Œè¿ç®—ï¼Œæ‰€ä»¥æ¯ä¸ªå…³é”®ç‚¹çš„xå’Œyåæ ‡éƒ½ä¼šå‡å»å¯¹åº”çš„<code>nearest_dis</code>å€¼çš„ä¸€åŠã€‚ç»“æœæ˜¯ä¸€ä¸ªå½¢çŠ¶ä¸º<code>(N, 2)</code>çš„æ•°ç»„ï¼Œå…¶ä¸­åŒ…å«äº†è°ƒæ•´åçš„xå’Œyåæ ‡ã€‚</p>
<ol>
<li><code>points_left_up</code> æ˜¯ä¸€ä¸ªå½¢çŠ¶ä¸º <code>(N, 2)</code> çš„NumPyæ•°ç»„ï¼Œå…¶ä¸­ <code>N</code> æ˜¯æŸä¸ªæ•°é‡ï¼ˆæ¯”å¦‚å…³é”®ç‚¹çš„æ•°é‡ï¼‰ï¼Œè€Œæ¯è¡ŒåŒ…å«ä¸¤ä¸ªå…ƒç´ ï¼Œä»£è¡¨æŸä¸ªâ€œå·¦ä¸Šâ€ç‚¹çš„xå’Œyåæ ‡ã€‚</li>
<li><code>points_right_down</code> æ˜¯ä¸€ä¸ªå½¢çŠ¶ä¸º <code>(N, 2)</code> çš„NumPyæ•°ç»„ï¼Œä¸ <code>points_left_up</code> ç±»ä¼¼ï¼Œä½†æ¯è¡ŒåŒ…å«çš„æ˜¯å¯¹åº”â€œå³ä¸‹â€ç‚¹çš„xå’Œyåæ ‡ã€‚</li>
</ol>
<ul>
<li><code>bbox = np.concatenate((points_left_up, points_right_down), axis=1)</code></li>
</ul>
<p>ç”±äº <code>points_left_up</code> å’Œ <code>points_right_down</code> éƒ½æ˜¯å½¢çŠ¶ä¸º <code>(N, 2)</code> çš„æ•°ç»„ï¼Œå½“æˆ‘ä»¬å°†å®ƒä»¬æ²¿ç€ <code>axis=1</code> è¿æ¥æ—¶ï¼Œç»“æœå°†æ˜¯ä¸€ä¸ªå½¢çŠ¶ä¸º <code>(N, 4)</code> çš„æ•°ç»„ã€‚è¿™ä¸ªæ–°æ•°ç»„ <code>bbox</code> çš„æ¯ä¸€è¡Œéƒ½å°†åŒ…å«å››ä¸ªå…ƒç´ ï¼šä¸¤ä¸ªæ¥è‡ª <code>points_left_up</code>ï¼ˆå·¦ä¸Šç‚¹çš„xå’Œyåæ ‡ï¼‰å’Œä¸¤ä¸ªæ¥è‡ª <code>points_right_down</code>ï¼ˆå³ä¸‹ç‚¹çš„xå’Œyåæ ‡ï¼‰ã€‚åœ¨è®¡ç®—æœºè§†è§‰çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™æ ·çš„ <code>bbox</code>ï¼ˆè¾¹ç•Œæ¡†ï¼‰é€šå¸¸ç”¨äºè¡¨ç¤ºå›¾åƒä¸­æŸä¸ªå¯¹è±¡çš„ä½ç½®å’Œå¤§å°ã€‚å·¦ä¸Šå’Œå³ä¸‹ç‚¹çš„åæ ‡å®šä¹‰äº†è¯¥å¯¹è±¡åœ¨å›¾åƒä¸­çš„çŸ©å½¢è¾¹ç•Œã€‚</p>
<p>è¿™ä¸ªå‡½æ•° <code>train_transform</code> æ˜¯åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ç”¨äºå¯¹å›¾åƒå’Œå…³é”®ç‚¹è¿›è¡Œä¸€ç³»åˆ—å˜æ¢çš„è‡ªå®šä¹‰å‡½æ•°ï¼Œç›®çš„æ˜¯å¢å¼ºæ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚è¯¥å‡½æ•°ä¸»è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li><strong>éšæœºè£å‰ªå›¾åƒ</strong>ï¼šé¦–å…ˆï¼Œå®ƒæ£€æŸ¥å›¾åƒçš„å°ºå¯¸ï¼ˆå®½åº¦å’Œé«˜åº¦ï¼‰ï¼Œç¡®ä¿å®ƒä»¬ä¸å°äºä¸€ä¸ªé¢„è®¾çš„æœ€å°è£å‰ªå°ºå¯¸ï¼ˆ<code>self.c_size</code>ï¼‰ã€‚ç„¶åï¼Œå®ƒä½¿ç”¨<code>random_crop</code>å‡½æ•°ï¼ˆè¯¥å‡½æ•°æœªåœ¨ä»£ç ä¸­å®šä¹‰ï¼Œä½†æˆ‘ä»¬å¯ä»¥å‡è®¾å®ƒè¿”å›ä¸€ä¸ªéšæœºçš„è£å‰ªåŒºåŸŸçš„ä½ç½®å’Œå¤§å°ï¼‰æ¥éšæœºé€‰æ‹©ä¸€ä¸ªè£å‰ªåŒºåŸŸï¼Œå¹¶å¯¹å›¾åƒè¿›è¡Œè£å‰ªã€‚è£å‰ªåçš„å›¾åƒå°†ç”¨äºåç»­çš„å¤„ç†ã€‚</li>
<li><strong>å¤„ç†å…³é”®ç‚¹</strong>ï¼šå¯¹äºç»™å®šçš„å…³é”®ç‚¹ï¼ˆé€šå¸¸æ˜¯äººä½“çš„å…³é”®éƒ¨ä½ï¼Œå¦‚çœ¼ç›ã€é¼»å­ã€è†ç›–ç­‰ï¼‰ï¼Œå‡½æ•°é¦–å…ˆè®¡ç®—æ¯ä¸ªå…³é”®ç‚¹åˆ°ä¸€ä¸ªâ€œæœ€è¿‘è·ç¦»â€çš„æ˜ å°„ï¼ˆ<code>nearest_dis</code>ï¼‰ï¼Œè¿™ä¸ªè·ç¦»å¯èƒ½æ˜¯æ ¹æ®å…³é”®ç‚¹å‘¨å›´çš„æŸç§ç‰¹å¾æˆ–å…ˆéªŒçŸ¥è¯†æ¥ç¡®å®šçš„ã€‚ç„¶åï¼Œå®ƒä½¿ç”¨è¿™ä¸ªè·ç¦»æ¥ä¸ºæ¯ä¸ªå…³é”®ç‚¹è®¡ç®—ä¸€ä¸ªå·¦ä¸Šå’Œå³ä¸‹åæ ‡ï¼Œä»è€Œå®šä¹‰ä¸€ä¸ªä»¥å…³é”®ç‚¹ä¸ºä¸­å¿ƒçš„çŸ©å½¢åŒºåŸŸï¼ˆå³è¾¹ç•Œæ¡†ï¼‰ã€‚</li>
<li><strong>è®¡ç®—äº¤å‰é¢ç§¯å’Œæ¯”ä¾‹</strong>ï¼šå‡½æ•°æ¥ç€è®¡ç®—è£å‰ªåçš„å›¾åƒåŒºåŸŸä¸æ‰€æœ‰å…³é”®ç‚¹è¾¹ç•Œæ¡†çš„äº¤å‰é¢ç§¯ï¼ˆ<code>inner_area</code>ï¼‰ï¼Œä»¥åŠæ‰€æœ‰å…³é”®ç‚¹è¾¹ç•Œæ¡†çš„åŸå§‹é¢ç§¯ï¼ˆ<code>origin_area</code>ï¼‰ã€‚ç„¶åï¼Œå®ƒè®¡ç®—äº¤å‰é¢ç§¯ä¸åŸå§‹é¢ç§¯çš„æ¯”ä¾‹ï¼ˆ<code>ratio</code>ï¼‰ï¼Œå¹¶å°†è¿™ä¸ªæ¯”ä¾‹ç”¨ä½œä¸€ä¸ªç­›é€‰æ ‡å‡†ï¼Œåªä¿ç•™é‚£äº›äº¤å‰é¢ç§¯æ¯”ä¾‹å¤§äºæˆ–ç­‰äº0.3çš„å…³é”®ç‚¹ã€‚</li>
<li><strong>è°ƒæ•´å…³é”®ç‚¹åæ ‡</strong>ï¼šå¯¹äºä¿ç•™ä¸‹æ¥çš„å…³é”®ç‚¹ï¼Œå‡½æ•°è°ƒæ•´å®ƒä»¬çš„åæ ‡ï¼Œä»¥åæ˜ å®ƒä»¬åœ¨è£å‰ªåçš„å›¾åƒä¸­çš„æ–°ä½ç½®ï¼ˆé€šè¿‡å‡å»è£å‰ªåŒºåŸŸçš„å·¦ä¸Šè§’åæ ‡<code>[j, i]</code>ï¼‰ã€‚</li>
<li><strong>éšæœºæ°´å¹³ç¿»è½¬</strong>ï¼šå‡½æ•°ä»¥0.5çš„æ¦‚ç‡å¯¹è£å‰ªåçš„å›¾åƒè¿›è¡Œæ°´å¹³ç¿»è½¬ã€‚å¦‚æœæ‰§è¡Œäº†ç¿»è½¬ï¼Œåˆ™ç›¸åº”åœ°è°ƒæ•´å…³é”®ç‚¹çš„xåæ ‡ã€‚</li>
<li><strong>è¿”å›å¤„ç†åçš„æ•°æ®</strong>ï¼šæœ€åï¼Œå‡½æ•°è¿”å›å¤„ç†åçš„å›¾åƒï¼ˆç»è¿‡å¯èƒ½çš„ç¿»è½¬å’Œé¢å¤–çš„å˜æ¢<code>self.trans</code>ï¼‰ã€ä¿ç•™çš„å…³é”®ç‚¹ï¼ˆè½¬æ¢ä¸ºPyTorchå¼ é‡å¹¶ä»…åŒ…å«xå’Œyåæ ‡ï¼‰ã€ç­›é€‰åçš„å…³é”®ç‚¹å¯¹åº”çš„äº¤å‰é¢ç§¯æ¯”ä¾‹ï¼ˆä¹Ÿè½¬æ¢ä¸ºPyTorchå¼ é‡ï¼‰ï¼Œä»¥åŠåŸå§‹å›¾åƒçš„è¾ƒçŸ­è¾¹å°ºå¯¸ï¼ˆ<code>st_size</code>ï¼‰ã€‚</li>
</ol>
<p>è¿™ä¸ªå‡½æ•°æ˜¯è®¡ç®—æœºè§†è§‰ä»»åŠ¡ä¸­å¸¸è§çš„æ•°æ®å¢å¼ºæ–¹æ³•çš„ä¸€ä¸ªä¾‹å­ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†ä¸äººä½“å§¿æ€æˆ–å…³é”®ç‚¹æ£€æµ‹ç›¸å…³çš„ä»»åŠ¡æ—¶ã€‚é€šè¿‡éšæœºè£å‰ªå’Œç¿»è½¬å›¾åƒï¼Œä»¥åŠæ ¹æ®å…³é”®ç‚¹ä¸è£å‰ªåŒºåŸŸçš„ç›¸å¯¹ä½ç½®æ¥ç­›é€‰å…³é”®ç‚¹ï¼Œè¯¥å‡½æ•°æœ‰åŠ©äºæ¨¡å‹å­¦ä¹ æ›´é²æ£’çš„ç‰¹å¾è¡¨ç¤ºã€‚</p>
<p><strong>ä¸datasetæƒ³é€‚åº”çš„collateè®¾è®¡</strong></p>
<pre><code class="lang-python">def train_collate(batch):
    transposed_batch = list(zip(*batch))
    # *batchï¼šè§£åŒ…batchï¼Œå°†batchåˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ ä½œä¸ºå•ç‹¬çš„å‚æ•°ä¼ é€’ç»™zipå‡½æ•°ã€‚
    # zip(*batch)ï¼šzipå‡½æ•°é€šå¸¸ç”¨äºå°†å¤šä¸ªå¯è¿­ä»£å¯¹è±¡çš„å…ƒç´ æ‰“åŒ…æˆä¸€ä¸ªä¸ªå…ƒç»„ï¼Œç„¶åå°†è¿™äº›å…ƒç»„è§£åŒ…æˆä¸€ä¸ªåˆ—è¡¨
    # batch = [  
    #     (img1, label1, data1),  
    #     (img2, label2, data2),  
    #     (img3, label3, data3),  
    #     # ... å¯èƒ½è¿˜æœ‰æ›´å¤šæ ·æœ¬  
    # ]

    # transposed_batch = [  
    #     (img1, img2, img3, ...),  # æ‰€æœ‰å›¾åƒçš„åˆ—è¡¨ï¼ˆæˆ–å…ƒç»„ï¼‰  
    #     (label1, label2, label3, ...),  # æ‰€æœ‰æ ‡ç­¾çš„åˆ—è¡¨ï¼ˆæˆ–å…ƒç»„ï¼‰  
    #     (data1, data2, data3, ...)  # æ‰€æœ‰å…¶ä»–æ•°æ®çš„åˆ—è¡¨ï¼ˆæˆ–å…ƒç»„ï¼‰  
    # ]

    # ä½¿ç”¨torch.stackæ²¿ç€æ–°çš„ç»´åº¦0å †å è¿™äº›å¼ é‡ã€‚(N,M)-&gt;(numbler_of_samples,N,M)
    images = torch.stack(transposed_batch[0], 0)
    points = transposed_batch[1]  # the number of points is not fixed, keep it as a list of tensor
    targets = transposed_batch[2]
    st_sizes = torch.FloatTensor(transposed_batch[3])
    return images, points, targets, st_sizes
</code></pre>
<h3 id="3-2-ğŸ§LOSSå‡½æ•°"><a href="#3-2-ğŸ§LOSSå‡½æ•°" class="headerlink" title="3.2 ğŸ§LOSSå‡½æ•°"></a>3.2 ğŸ§LOSSå‡½æ•°</h3><pre><code class="lang-python">self.post_prob = Post_Prob(args.sigma,
                           args.crop_size,
                           args.downsample_ratio,
                           args.background_ratio,
                           args.use_background,
                           self.device)
self.criterion = Bay_Loss(args.use_background, self.device)
</code></pre>
<h4 id="3-2-1-Post-Prob"><a href="#3-2-1-Post-Prob" class="headerlink" title="3.2.1 Post_Prob"></a>3.2.1 Post_Prob</h4><p><strong>åéªŒæ¦‚ç‡</strong><code>ï¼ˆPosterior Probabilityï¼‰</code></p>
<pre><code class="lang-python">class Post_Prob(Module):
    def __init__(self, sigma, c_size, stride, background_ratio, use_background, device):
        super(Post_Prob, self).__init__()
        assert c_size % stride == 0

        self.sigma = sigma
        self.bg_ratio = background_ratio
        self.device = device
        # coordinate is same to image space, set to constant since crop size is same
        self.cood = torch.arange(0, c_size, step=stride,
                                 dtype=torch.float32, device=device) + stride / 2
        self.cood.unsqueeze_(0)
        self.softmax = torch.nn.Softmax(dim=0)
        self.use_bg = use_background

    def forward(self, points, st_sizes):
        num_points_per_image = [len(points_per_image) for points_per_image in points]
        # points = [  
        # [point1_image1, point2_image1, ...],  # ç¬¬ä¸€ä¸ªå›¾åƒçš„ç‚¹åˆ—è¡¨  
        # [point1_image2, point2_image2, ...],  # ç¬¬äºŒä¸ªå›¾åƒçš„ç‚¹åˆ—è¡¨  
        # ... ]
        # è®¡ç®—æ¯å›¾åƒçš„ç‚¹æ•°ï¼Œå¹¶å­˜åˆ°num_points_per_imageä¸­ã€‚

        all_points = torch.cat(points, dim=0)

        if len(all_points) &gt; 0:
            x = all_points[:, 0].unsqueeze_(1)   # æå–ç¬¬ä¸€åˆ—åå†å¢åŠ ä¸€ä¸ªç»´åº¦ (N, 1)
            y = all_points[:, 1].unsqueeze_(1)   # æå–ç¬¬äºŒåˆ—åå†å¢åŠ ä¸€ä¸ªç»´åº¦ (N, 1)
            x_dis = -2 * torch.matmul(x, self.cood) + x * x + self.cood * self.cood
            y_dis = -2 * torch.matmul(y, self.cood) + y * y + self.cood * self.cood

            y_dis.unsqueeze_(2)
            x_dis.unsqueeze_(1)
            dis = y_dis + x_dis
            dis = dis.view((dis.size(0), -1))
            dis_list = torch.split(dis, num_points_per_image)
            prob_list = []
            for dis, st_size in zip(dis_list, st_sizes):
                if len(dis) &gt; 0:
                    if self.use_bg:
                        min_dis = torch.clamp(torch.min(dis, dim=0, keepdim=True)[0], min=0.0)
                        bg_dis = (st_size * self.bg_ratio) ** 2 / (min_dis + 1e-5)
                        dis = torch.cat([dis, bg_dis], 0)  # concatenate background distance to the last
                    dis = -dis / (2.0 * self.sigma ** 2)
                    prob = self.softmax(dis)
                else:
                    prob = None
                prob_list.append(prob)
        else:
            prob_list = []
            for _ in range(len(points)):
                prob_list.append(None)
        return prob_lis
</code></pre>
<p><img src="https://raw.githubusercontent.com/Aircraft-carrier/PicGOO/main/images/gongshi3.png"/></p>
<p>è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªåä¸º<code>Post_Prob</code>çš„ç±»ï¼Œè¯¥ç±»ç»§æ‰¿è‡ªPyTorchçš„<code>Module</code>ç±»ï¼Œç”¨äºæ‰§è¡Œåå¤„ç†æ“ä½œï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†ä¸å›¾åƒä¸­ç‚¹ç›¸å…³çš„ä»»åŠ¡æ—¶ï¼Œå¦‚ç›®æ ‡æ£€æµ‹æˆ–å…³é”®ç‚¹æ£€æµ‹ç­‰ã€‚è¿™ä¸ªç±»çš„ä¸»è¦ç›®çš„æ˜¯æ ¹æ®ç»™å®šçš„ç‚¹ï¼ˆå¯èƒ½æ˜¯æ£€æµ‹åˆ°çš„ç›®æ ‡æˆ–å…³é”®ç‚¹ï¼‰å’Œä¸€ç³»åˆ—å‚æ•°ï¼Œè®¡ç®—è¿™äº›ç‚¹ç›¸å¯¹äºæŸä¸ªå›ºå®šç½‘æ ¼ï¼ˆæˆ–åæ ‡ç³»ç»Ÿï¼‰çš„æ¦‚ç‡åˆ†å¸ƒã€‚ä¸‹é¢æ˜¯å¯¹è¿™ä¸ªç±»åŠå…¶æ–¹æ³•çš„è¯¦ç»†åˆ†æï¼š</p>
<p><strong>å‰å‘ä¼ æ’­å‡½æ•°</strong> <code>forward</code></p>
<ul>
<li><p>å‚æ•°</p>
<ol>
<li><code>points</code>ï¼šä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«æ¯ä¸ªå›¾åƒä¸­æ£€æµ‹åˆ°çš„ç‚¹çš„åæ ‡ï¼ˆäºŒç»´ï¼Œæ¯è¡Œä¸€ä¸ªç‚¹ï¼‰ã€‚</li>
</ol>
<ul>
<li><code>st_sizes</code>ï¼šä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«æ¯ä¸ªå›¾åƒçš„æ ‡å‡†å°ºå¯¸ï¼ˆæˆ–ç‰¹å¾å°ºå¯¸ï¼‰ï¼Œå¯èƒ½ç”¨äºè®¡ç®—èƒŒæ™¯è·ç¦»ã€‚</li>
</ul>
</li>
<li><p>æ“ä½œ</p>
<ul>
<li>é¦–å…ˆï¼Œè®¡ç®—æ¯ä¸ªå›¾åƒä¸­ç‚¹çš„æ•°é‡ï¼Œå¹¶å­˜å‚¨åœ¨<code>num_points_per_image</code>ä¸­ã€‚</li>
<li>å°†æ‰€æœ‰å›¾åƒçš„ç‚¹åˆå¹¶åˆ°ä¸€ä¸ªå•ä¸€çš„å¼ é‡<code>all_points</code>ä¸­ï¼Œæ–¹ä¾¿åç»­æ‰¹é‡å¤„ç†ã€‚</li>
<li>æå–<code>all_points</code>ä¸­çš„xå’Œyåæ ‡ï¼Œå¹¶åˆ†åˆ«å¢åŠ ä¸€ä¸ªç»´åº¦ä»¥åŒ¹é…çŸ©é˜µä¹˜æ³•çš„è¦æ±‚ã€‚</li>
<li>è®¡ç®—æ¯ä¸ªç‚¹ä¸åæ ‡ç½‘æ ¼ä¸Šæ¯ä¸ªç‚¹ä¹‹é—´çš„å¹³æ–¹è·ç¦»ï¼ˆ<code>x_dis</code>å’Œ<code>y_dis</code>ï¼‰ï¼Œç„¶åç›¸åŠ å¾—åˆ°æ€»è·ç¦»<code>dis</code>ã€‚</li>
<li>å°†<code>dis</code>å¼ é‡é‡æ–°æ•´å½¢ï¼Œå¹¶æ ¹æ®æ¯ä¸ªå›¾åƒä¸­ç‚¹çš„æ•°é‡åˆ†å‰²æˆ<code>dis_list</code>ï¼Œä»¥ä¾¿å¯¹æ¯ä¸ªå›¾åƒåˆ†åˆ«å¤„ç†ã€‚</li>
<li>å¯¹äº<code>dis_list</code>ä¸­çš„æ¯ä¸ª<code>dis</code>å’Œå¯¹åº”çš„<code>st_size</code>ï¼Œè®¡ç®—è¯¥å›¾åƒä¸­æ¯ä¸ªç‚¹ç›¸å¯¹äºåæ ‡ç½‘æ ¼çš„æ¦‚ç‡åˆ†å¸ƒï¼ˆè™½ç„¶ä»£ç ä¸­å¹¶æœªç›´æ¥è®¡ç®—æ¦‚ç‡ï¼Œè€Œæ˜¯è®¡ç®—äº†è·ç¦»ï¼Œä½†åŸºäºè¿™äº›è·ç¦»å¯ä»¥è¿›ä¸€æ­¥è®¡ç®—é«˜æ–¯æ¦‚ç‡ï¼‰ã€‚</li>
<li>å¦‚æœå¯ç”¨äº†èƒŒæ™¯ç‚¹ï¼ˆ<code>self.use_bg</code>ä¸ºçœŸï¼‰ï¼Œåˆ™è®¡ç®—èƒŒæ™¯ç‚¹çš„â€œè·ç¦»â€ï¼Œè¿™é‡Œçš„â€œè·ç¦»â€å®é™…ä¸Šæ˜¯åŸºäºæœ€å°è·ç¦»å’ŒèƒŒæ™¯æ¯”ç‡è®¡ç®—çš„ä¸€ä¸ªå€¼ï¼Œç”¨äºåœ¨æ¦‚ç‡åˆ†å¸ƒä¸­è€ƒè™‘èƒŒæ™¯åŒºåŸŸã€‚</li>
</ul>
</li>
</ul>
<h4 id="3-2-2-Bay-Loss"><a href="#3-2-2-Bay-Loss" class="headerlink" title="3.2.2  Bay_Loss"></a>3.2.2  Bay_Loss</h4><p><strong>è´å¶æ–¯æ¦‚ç‡</strong></p>
<pre><code class="lang-python">class Bay_Loss(Module): 
    def __init__(self, use_background, device):
        super(Bay_Loss, self).__init__()
        self.device = device
        self.use_bg = use_background

    def forward(self, prob_list, target_list, pre_density):
        loss = 0
        for idx, prob in enumerate(prob_list):  # iterative through each sample
            if prob is None:  # image contains no annotation points
                pre_count = torch.sum(pre_density[idx])
                target = torch.zeros((1,), dtype=torch.float32, device=self.device)
            else:
                N = len(prob)
                if self.use_bg:
                    target = torch.zeros((N,), dtype=torch.float32, device=self.device)
                    target[:-1] = target_list[idx]
                else:
                    target = target_list[idx]
                pre_count = torch.sum(pre_density[idx].view((1, -1)) * prob, dim=1)  # flatten into vector

            loss += torch.sum(torch.abs(target - pre_count))
        loss = loss / len(prob_list)
        return loss
</code></pre>
<h3 id="3-3-ğŸ•Šï¸æ¨¡å‹ç½‘ç»œè®¾è®¡å’Œè®­ç»ƒè¿‡ç¨‹"><a href="#3-3-ğŸ•Šï¸æ¨¡å‹ç½‘ç»œè®¾è®¡å’Œè®­ç»ƒè¿‡ç¨‹" class="headerlink" title="3.3  ğŸ•Šï¸æ¨¡å‹ç½‘ç»œè®¾è®¡å’Œè®­ç»ƒè¿‡ç¨‹"></a>3.3  ğŸ•Šï¸æ¨¡å‹ç½‘ç»œè®¾è®¡å’Œè®­ç»ƒè¿‡ç¨‹</h3><h4 id="3-3-1-vggæ¨¡å‹ç®€ä»‹"><a href="#3-3-1-vggæ¨¡å‹ç®€ä»‹" class="headerlink" title="3.3.1 vggæ¨¡å‹ç®€ä»‹"></a>3.3.1 vggæ¨¡å‹ç®€ä»‹</h4><p><code>self.model =vgg19()</code></p>
<p>VGG19æ¨¡å‹æ˜¯ä¸€ä¸ªæ·±åº¦å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰ï¼Œç”±ç‰›æ´¥å¤§å­¦çš„Visual Geometry Groupï¼ˆVGGï¼‰ç ”ç©¶å›¢é˜Ÿå¼€å‘å¹¶å‘½åã€‚è¯¥æ¨¡å‹åœ¨å¤šä¸ªæ–¹é¢å±•ç°å‡ºäº†å…¶é‡è¦çš„ä½œç”¨å’Œä¼˜åŠ¿ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>å›¾åƒå¤„ç†ä¸åˆ†ç±»</strong></li>
</ul>
<ol>
<li><strong>å›¾åƒåˆ†ç±»</strong>ï¼šVGG19åœ¨2014å¹´çš„ImageNetå›¾åƒè¯†åˆ«æŒ‘æˆ˜èµ›ä¸­å–å¾—äº†éå¸¸ä¼˜ç§€çš„æˆç»©ï¼Œè¯æ˜äº†å…¶åœ¨å›¾åƒåˆ†ç±»ä»»åŠ¡ä¸­çš„å¼ºå¤§èƒ½åŠ›ã€‚å®ƒèƒ½å¤Ÿé€šè¿‡å­¦ä¹ å›¾åƒä¸­çš„ç‰¹å¾ï¼Œå°†å›¾åƒå‡†ç¡®åœ°åˆ†ç±»åˆ°ä¸åŒçš„ç±»åˆ«ä¸­ã€‚</li>
<li><strong>ç‰¹å¾æå–</strong>ï¼šVGG19çš„æ¯ä¸€å±‚éƒ½å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç‰¹å¾æå–å™¨ï¼Œä¸“æ³¨äºä»è¾“å…¥æ•°æ®ä¸­æå–å±€éƒ¨ç‰¹å¾ã€‚è¿™äº›ç‰¹å¾ç»è¿‡ä¸€ç³»åˆ—çš„éçº¿æ€§å˜æ¢å’Œç»„åˆï¼Œæœ€ç»ˆå½¢æˆå®Œæ•´çš„å›¾åƒè¡¨ç¤ºï¼Œè¿™å¯¹äºå›¾åƒå¤„ç†å’Œè®¡ç®—æœºè§†è§‰ä»»åŠ¡è‡³å…³é‡è¦ã€‚</li>
</ol>
<ul>
<li><strong>2. ç»“æ„ç‰¹ç‚¹ä¸ä¼˜åŠ¿</strong></li>
</ul>
<ol>
<li><strong>ç½‘ç»œæ·±åº¦</strong>ï¼šVGG19çš„åç§°ä¸­çš„â€œ19â€ä»£è¡¨ç€å…¶ç½‘ç»œçš„æ€»å±‚æ•°ï¼ˆåŒ…æ‹¬å·ç§¯å±‚å’Œå…¨è¿æ¥å±‚ï¼‰ï¼Œè¿™ä½¿å¾—å®ƒæˆä¸ºå½“æ—¶ç›¸å¯¹è¾ƒæ·±çš„ç¥ç»ç½‘ç»œä¹‹ä¸€ã€‚æ·±åº¦ç½‘ç»œæœ‰åŠ©äºæ¨¡å‹å­¦ä¹ åˆ°æ›´å¤æ‚çš„ç‰¹å¾è¡¨ç¤ºï¼Œä»è€Œæé«˜æ¨¡å‹çš„æ€§èƒ½ã€‚</li>
<li><strong>å·ç§¯æ ¸ä¸æ± åŒ–å±‚</strong>ï¼šVGG19ä½¿ç”¨äº†å¤šä¸ªè¿ç»­çš„å°å‹å·ç§¯æ ¸ï¼ˆå¦‚3x3ï¼‰æ¥æ›¿ä»£å•ä¸€çš„å¤§å‹å·ç§¯æ ¸ã€‚è¿™ç§è®¾è®¡ä¸ä»…å¢åŠ äº†ç½‘ç»œå¯¹ä¸åŒå°ºåº¦ç‰¹å¾çš„æ•æ‰èƒ½åŠ›ï¼Œè¿˜æé«˜äº†æ¨¡å‹çš„æ³›åŒ–æ€§èƒ½ã€‚åŒæ—¶ï¼Œæ¯ä¸¤ä¸ªå·ç§¯å±‚ä¹‹é—´éƒ½æ’å…¥äº†ä¸€ä¸ªæ± åŒ–å±‚ï¼ˆå¦‚2x2çš„æ± åŒ–æ ¸ï¼‰ï¼Œæœ‰åŠ©äºå‡å°‘ç‰¹å¾å›¾çš„å°ºå¯¸å’Œè®¡ç®—é‡ã€‚</li>
</ol>
<ul>
<li><strong>3 è¿ç§»å­¦ä¹ ä¸é¢„è®­ç»ƒæ¨¡å‹</strong></li>
</ul>
<ol>
<li><strong>é¢„è®­ç»ƒæ¨¡å‹</strong>ï¼šVGG19æœ‰ä¸€ä¸ªé¢„è®­ç»ƒçš„ç‰ˆæœ¬ï¼Œè¿™æ„å‘³ç€å¯ä»¥ç›´æ¥ä½¿ç”¨åœ¨å¤§é‡å›¾åƒæ•°æ®ä¸Šè®­ç»ƒå¥½çš„æ¨¡å‹å‚æ•°ï¼Œè€Œä¸éœ€è¦ä»å¤´å¼€å§‹è®­ç»ƒã€‚è¿™å¤§å¤§èŠ‚çœäº†è®­ç»ƒæ—¶é—´ï¼Œå¹¶ä½¿å¾—VGG19èƒ½å¤Ÿåœ¨æ•°æ®è¾ƒå°‘çš„ä»»åŠ¡ä¸­è¡¨ç°å‡ºè‰²ã€‚</li>
<li><strong>è¿ç§»å­¦ä¹ </strong>ï¼šè¿ç§»å­¦ä¹ æ˜¯ä¸€ç§å°†åœ¨ä¸€ä¸ªä»»åŠ¡ä¸Šè®­ç»ƒå¥½çš„æ¨¡å‹åº”ç”¨åˆ°å¦ä¸€ä¸ªç›¸å…³ä»»åŠ¡ä¸Šçš„æ–¹æ³•ã€‚VGG19çš„é¢„è®­ç»ƒæ¨¡å‹å¯ä»¥ä½œä¸ºæ–°ä»»åŠ¡çš„èµ·ç‚¹ï¼Œé€šè¿‡åœ¨æ–°æ•°æ®ä¸Šè¿›è¡Œå¾®è°ƒæ¥é€‚åº”æ–°çš„ä»»åŠ¡éœ€æ±‚ã€‚</li>
</ol>
<ul>
<li><strong>4 åº”ç”¨é¢†åŸŸ</strong></li>
</ul>
<ol>
<li><strong>å›¾åƒè¯†åˆ«</strong>ï¼šVGG19å¹¿æ³›åº”ç”¨äºè‡ªç„¶å›¾åƒè¯†åˆ«é¢†åŸŸï¼ŒåŒ…æ‹¬ä½†ä¸é™äºåŠ¨ç‰©ã€æ¤ç‰©ã€è½¦è¾†ç­‰ç‰©ä½“çš„è¯†åˆ«ã€‚</li>
<li><strong>ç‰©ä½“æ£€æµ‹</strong>ï¼šåœ¨ç‰©ä½“æ£€æµ‹ä»»åŠ¡ä¸­ï¼ŒVGG19å¯ä»¥ä½œä¸ºç‰¹å¾æå–å™¨ï¼Œä¸æ£€æµ‹ç®—æ³•ç›¸ç»“åˆæ¥å®šä½å›¾åƒä¸­çš„ç‰©ä½“ã€‚</li>
<li><strong>è¯­ä¹‰åˆ†å‰²</strong>ï¼šåœ¨è¯­ä¹‰åˆ†å‰²ä»»åŠ¡ä¸­ï¼ŒVGG19å¯ä»¥å¸®åŠ©æ¨¡å‹ç†è§£å›¾åƒä¸­æ¯ä¸ªåƒç´ çš„ç±»åˆ«ä¿¡æ¯ï¼Œä»è€Œå®ç°ç²¾ç»†çš„å›¾åƒåˆ†å‰²ã€‚</li>
</ol>
<p><strong>5 åç»­å½±å“ä¸æ”¹è¿›</strong></p>
<ol>
<li><strong>åç»­ç ”ç©¶</strong>ï¼šVGG19çš„æˆåŠŸå¯å‘äº†åç»­ç ”ç©¶è€…ä½¿ç”¨æ›´æ·±ã€æ›´å¤æ‚çš„ç½‘ç»œæ¶æ„æ¥è§£å†³è®¡ç®—æœºè§†è§‰é¢†åŸŸçš„é—®é¢˜ã€‚è®¸å¤šæ”¹è¿›å’Œå˜ç§éƒ½æ˜¯åŸºäºVGG19çš„ç»“æ„è¿›è¡Œçš„ã€‚</li>
<li><strong>ä¼˜åŒ–ç­–ç•¥</strong>ï¼šä¸ºäº†è§£å†³VGG19å‚æ•°é‡è¾ƒå¤§ã€è®¡ç®—å¤æ‚åº¦è¾ƒé«˜ç­‰é—®é¢˜ï¼Œç ”ç©¶è€…ä»¬æå‡ºäº†è®¸å¤šä¼˜åŒ–ç­–ç•¥ï¼Œå¦‚çŸ¥è¯†è’¸é¦ã€è½»é‡çº§ç½‘ç»œç»“æ„è®¾è®¡ç­‰ï¼Œä»¥æé«˜æ¨¡å‹æ•ˆç‡å’Œæ€§èƒ½ã€‚</li>
</ol>
<p>ç»¼ä¸Šæ‰€è¿°ï¼ŒVGG19æ¨¡å‹åœ¨å›¾åƒå¤„ç†ä¸åˆ†ç±»ã€ç‰¹å¾æå–ã€è¿ç§»å­¦ä¹ ä¸é¢„è®­ç»ƒæ¨¡å‹ä»¥åŠå¤šä¸ªåº”ç”¨é¢†åŸŸä¸­éƒ½å‘æŒ¥ç€é‡è¦ä½œç”¨ã€‚å…¶ç‹¬ç‰¹çš„ç½‘ç»œç»“æ„å’Œå¼ºå¤§çš„ç‰¹å¾æå–èƒ½åŠ›ä½¿å¾—å®ƒæˆä¸ºè®¡ç®—æœºè§†è§‰é¢†åŸŸä¸­çš„ç»å…¸æ¨¡å‹ä¹‹ä¸€ã€‚</p>
<h2 id="4-å®éªŒç»“æœè®°å½•"><a href="#4-å®éªŒç»“æœè®°å½•" class="headerlink" title="4 å®éªŒç»“æœè®°å½•"></a>4 å®éªŒç»“æœè®°å½•</h2><pre><code class="lang-python">python preprocess_dataset.py --origin-dir ../tmp/UCF-QNRF_ECCV18 --data-dir ../teddy/UCF-Train-Val-Test
</code></pre>
<pre><code class="lang-python">python train.py --data-dir ../teddy/UCF-Train-Val-Test --save-dir ../teddy/vgg
</code></pre>
<p><img src="https://raw.githubusercontent.com/Aircraft-carrier/PicGOO/main/images/labre1-7-4.png"/></p>
<p>åé¢å¤§æ¦‚æ˜¯æœåŠ¡å™¨æ¬ è´¹è‡ªåŠ¨æˆªæ­¢è®­ç»ƒäº†ï¼Œè€ƒè™‘åˆ°å·²ç»å¾—åˆ°æ¯”åŸæ¨¡å‹å¥½çš„ç»“æœå°±æ²¡æœ‰è¿›è¡Œ2æ¬¡è®­ç»ƒã€‚</p>
<pre><code class="lang-python">python test.py --data-dir ../teddy/UCF-Train-Val-Test --save-dir ../teddy/vgg
</code></pre>
<p><img src="https://raw.githubusercontent.com/Aircraft-carrier/PicGOO/main/images/labre2-7-4.png"/></p>
<h3 id="ç»“æœå¯è§†åŒ–"><a href="#ç»“æœå¯è§†åŒ–" class="headerlink" title="ç»“æœå¯è§†åŒ–"></a>ç»“æœå¯è§†åŒ–</h3><pre><code class="lang-python">import numpy as np
import matplotlib.pyplot as plt
import matplotlib.cm as CM
import os

npy_folder = &#39;./npyfile&#39;
image_folder = &#39;./image&#39;

if not os.path.exists(image_folder):
    os.makedirs(image_folder)

for npy_file in os.listdir(npy_folder):
    if npy_file.endswith(&#39;.npy&#39;):
        dm = np.load(os.path.join(npy_folder, npy_file))

        # Normalize the input data
        dm_normalized = dm / np.max(dm)

        fig, ax = plt.subplots()
        ax.imshow(dm_normalized[0, 0], cmap=CM.jet, vmin=0, vmax=1)  # Adjust indexing as needed

        name = os.path.splitext(npy_file)[0]
        plt.savefig(os.path.join(image_folder, &#39;&#123;&#125;.png&#39;.format(name)))
</code></pre>
<ul>
<li><code>test/img_0001.jpg</code>æµ‹è¯•</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Aircraft-carrier/PicGOO/images/img_0001.jpg"/></p>
<p>ä»£ç æ®µä¸€ï¼š</p>
<pre><code class="lang-python">import numpy as np
import matplotlib.pyplot as plt
import matplotlib.cm as CM
import os

npy_path = &quot;teddy\\UCF-Train-Val-Test\\npyfile&quot;
images_path = &quot;teddy\\UCF-Train-Val-Test\\test&quot;
npy_file = &quot;img_0001.npy&quot;

data_pre = np.load(os.path.join(npy_path, npy_file))
print(&quot;data_pre[0,0] :&quot;,data_pre[0,0])
print(&quot;data_pre.shape :&quot;,data_pre.shape)
print(np.sum(data_pre))
# Normalize the input data
data_pre_normalized = data_pre / np.max(data_pre)

print(&quot;-&quot;*50)
data_test = np.load(os.path.join(images_path, npy_file))
print(&quot;data_test :&quot;,data_test)
print(&quot;data_test.shape :&quot;,data_test.shape)
</code></pre>
<p>è¾“å‡ºï¼š</p>
<pre><code class="lang-bash">data_pre[0,0] : [[5.2732881e-05 4.4326764e-05 1.9371044e-05 ... 1.0430161e-04
  2.6183669e-05 3.2673590e-05]
 [2.0994106e-04 4.2500580e-04 3.4432928e-03 ... 3.9682258e-05
  1.7801765e-05 1.7811265e-04]
 [5.6461222e-03 4.3547332e-02 3.5645209e-02 ... 6.0658390e-04
  4.1515566e-05 9.3833078e-05]
 ...
 [1.4514025e-02 4.7545478e-02 4.9227014e-02 ... 1.6733538e-05
  1.7937738e-05 7.8277662e-06]
 [5.9578894e-04 2.3728251e-03 6.3006370e-03 ... 1.6372651e-05
  1.4228746e-05 1.0157935e-05]
 [8.0659054e-05 9.9725090e-05 5.7616737e-05 ... 1.7749611e-05
  1.6583595e-05 1.2622215e-05]]
data_pre.shape : (1, 1, 234, 312)
1203.4796
-----------------------------------------------------------------------
data_test : [[ 445.19424 1790.518  ]
 [ 474.8705  1739.259  ]
 [ 512.64026 1820.1942 ]
 ...
 [ 972.7157  1494.6793 ]
 [1933.0287   181.25717]
 [1572.6423   134.19641]]
data_test.shape : (975, 2)
</code></pre>
<p>ä»£ç æ®µäºŒï¼š</p>
<pre><code class="lang-python">fig, ax = plt.subplots()
ax.imshow(data_pre_normalized[0, 0], cmap=CM.jet, vmin=0, vmax=1)  # Adjust indexing as needed
ax.set_title(&#39;Normalized Image&#39;)
plt.show()
</code></pre>
<p>è¾“å‡º</p>
<p><img src="https://cdn.jsdelivr.net/gh/Aircraft-carrier/PicGOO/images/bayes_test1.png"/></p>
<p>ä»£ç æ®µä¸‰ï¼š</p>
<pre><code class="lang-python">from matplotlib import pyplot as plt
from matplotlib import cm as CM
import cv2
import scipy.ndimage
import scipy.io

def gaussian_filter_density(gt):
    # åˆå§‹åŒ–å¯†åº¦å›¾
    density = np.zeros(gt.shape, dtype=np.float32)
    # è·å–gtä¸­ä¸ä¸º0çš„å…ƒç´ çš„ä¸ªæ•°
    gt_count = np.count_nonzero(gt)
    # å¦‚æœgtå…¨ä¸º0ï¼Œå°±è¿”å›å…¨0çš„å¯†åº¦å›¾
    if gt_count == 0:
        return density 
    sigma = 16
    density += scipy.ndimage.filters.gaussian_filter(gt, sigma, mode=&#39;constant&#39;)
    return density
def density_map(img,gt):
    k = np.zeros((img.shape[0],img.shape[1]))
    for i in range(len(gt)):#ç”Ÿæˆå¤´éƒ¨ç‚¹æ³¨é‡Šå›¾
        if gt[i][0] &lt; img.shape[1] and gt[i][1] &lt; img.shape[0]:
            k[int(gt[i][1])][int(gt[i][0])] += 1
    k = gaussian_filter_density(k)
    return k

gt = data_test
image = os.path.splitext(npy_file)[0] + &#39;.jpg&#39;
img = cv2.imread(os.path.join(images_path,image))

groundtruth = density_map(img,gt)
plt.figure(2)

plt.imshow(groundtruth,cmap=CM.jet)
plt.show()
</code></pre>
<p>è¾“å‡ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/Aircraft-carrier/PicGOO/images/bayes_test2.png"/></p>
<p>ä»£ç æ®µå››ï¼š</p>
<pre><code class="lang-python">import numpy as np
from PIL import Image

data = data_pre[0,0] 

# è¯»å–.jpgæ–‡ä»¶ï¼Œè·å–å…¶å¤§å°
image = Image.open(image_path)
image_size = image.size

# è°ƒæ•´.npyæ–‡ä»¶çš„å¤§å°ä»¥åŒ¹é….jpgæ–‡ä»¶çš„å¤§å°
data_resized = np.array(Image.fromarray(data).resize(image_size))

# åˆ›å»ºä¸€ä¸ªæ–°çš„å¯è§†åŒ–å›¾åƒ
fig, ax = plt.subplots()
ax.imshow(data_resized, cmap=&#39;gray&#39;)  # æ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„è‰²å½©æ˜ å°„

# å°†.jpgå›¾åƒå åŠ åœ¨.npyæ•°æ®ä¸Š
ax.imshow(image, alpha=0.5)  # è°ƒæ•´alphaå€¼æ§åˆ¶å›¾åƒé‡å çš„é€æ˜åº¦

plt.axis(&#39;off&#39;)  # å…³é—­åæ ‡è½´
plt.show()
</code></pre>
<p>è¾“å‡ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/Aircraft-carrier/PicGOO/images/bayes_test3.png"/></p>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°è®­ç»ƒè¾“å‡ºç»“æœå’ŒåŸæœ¬çš„æ•°æ®åŸºæœ¬ä¸€è‡´</p>
<p>è®­ç»ƒè¾“å‡ºç»“æœé‡‡ç”¨å›¾å­˜å‚¨æ¨¡å¼å³ï¼š(234, 312)</p>
<p>åŸå§‹æ•°æ®ç»“æœé‡‡ç”¨ç‚¹å­˜å‚¨æ¨¡å¼å³ï¼š(975, 2)</p>
</blockquote>

    </div>
    
    
    
    
    <div id="comment">
        <div id="giscus-container" class="giscus"></div>
    </div>
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2024 Aircraft
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;Aircraft
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    
<script
    src="https://giscus.app/client.js"
    data-repo="Aircraft-carrier/git-discussions-"
    data-repo-id="R_kgDOMSMEYQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOMSMEYc4CglYu"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light_tritanopia"
    data-lang="zh-CN"
    crossorigin
    async
></script>









    

    <canvas
        id="fireworks"
        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 32767"
    ></canvas>
    <script src="https://s4.zstatic.net/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="/js/fireworks.min.js"></script>  

    <canvas
        id="background"
        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: -1"
    ></canvas>
    <script src="/js/background.min.js"></script>

    <div id="cursor"></div>
    <link rel="stylesheet" href="/css/cursor.min.css" />
    <script src="/js/cursor.min.js"></script>

</body>
</html>
